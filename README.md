# Jani Platform

Полноценный прототип Telegram Mini App + Bot для ролевого опыта в стиле "Архиватор". Репозиторий содержит монорепозиторий pnpm с сервисами Fastify/grammY и пакетами общих типов. Все пользовательские интерфейсы для клиентов (Mini App/PWA/Bot) представлены на русском языке.

## Структура

```
apps/
  gateway/        # REST API для Mini App / PWA
  bot/            # Telegram бот на grammY
  orchestrator/   # Оркестратор диалогов и эффектов
  billing/        # Управление подписками и пакетами
  shop/           # Каталог предметов и потребление
  persona/        # CRUD персонажей/историй для админов
  pwa/            # React/Vite PWA для локальной отладки
packages/
  shared/         # Общие типы, перечисления, конфиг
  db/             # InMemoryDatabase + сиды персонажей/предметов
```

## Быстрый старт

1. Установите зависимости:
   ```bash
   pnpm install
   ```
2. Запустите нужные сервисы в отдельных окнах (все используют общий InMemoryDatabase):
   ```bash
   pnpm dev:gateway
   pnpm dev:bot            # требует TELEGRAM_BOT_TOKEN
   pnpm dev:orchestrator
   pnpm dev:billing
   pnpm dev:shop
   pnpm dev:persona
   pnpm dev:pwa
   ```
3. Для запуска бота задайте переменные окружения:
   ```bash
   export TELEGRAM_BOT_TOKEN=123:ABC
   pnpm dev:bot
   ```
4. PWA доступна на `http://localhost:5173` и использует общий API `http://localhost:3000` (прокси через devServer).

### Авторизация Mini App

- Реальные мини-приложения передают строку `initData` в query или теле запроса. Gateway валидирует подпись по алгоритму Telegram (HMAC-SHA256 + `WebAppData`). Для этого задайте один из секретов:
  - `TELEGRAM_WEBAPP_SECRET` — готовый secret key (hex или utf-8).
  - `TELEGRAM_BOT_TOKEN` — токен бота; secret выводится автоматически.
- Дополнительно можно настроить TTL подписи через `TELEGRAM_INITDATA_MAX_AGE` (секунды, по умолчанию 86400).
- Локальная PWA по-прежнему доступна через DEV-ветку авторизации — включается автоматически, если `NODE_ENV !== 'production'` или `GATEWAY_ALLOW_DEV_AUTH=true`, и использует заголовок `x-telegram-id`.

## Тестирование

Все основные сценарии покрыты Vitest (диалог, магазин, подписки, квоты, CRUD персонажей).

```bash
pnpm test
```

## Возможности

- Мини-приложение (через Gateway API) выдаёт персонажей, создаёт диалоги, рассчитывает квоты и возвращает русский текст.
- Оркестратор комбинирует суммаризацию последних сообщений, память (в том числе эффекты Memory Pack) и действия (offer/consume).
- Магазин поддерживает скидки по подпискам, выдачу предметов и активацию эффектов, включая сюжетные ключи.
- Биллинг выпускает счета для подписок и пакетов, мгновенно назначая подписку/пакет в режиме Stars mock.
- Persona-сервис позволяет админам добавлять новых персонажей, истории и версии.
- Telegram бот строится на grammY, поддерживает inline-кнопки покупки и учитывает дневные лимиты.
- PWA (RU UI) напоминает о режиме отладки Stars.

## Переменные окружения

- `TELEGRAM_BOT_TOKEN` — токен бота (обязателен для `pnpm dev:bot`, также может использоваться для проверки initData).
- `TELEGRAM_WEBAPP_SECRET` — опциональный secret key для проверки initData (если задан, токен не требуется).
- `TELEGRAM_INITDATA_MAX_AGE` — TTL `initData` в секундах (по умолчанию 86400).
- `GATEWAY_ALLOW_DEV_AUTH` — разрешить DEV-ветку авторизации (по умолчанию включена, кроме production).

Прочие настройки (лимиты, цены) зашиты в `packages/shared/src/config.ts`, при необходимости их можно изменить перед запуском.

## Ограничения прототипа

- Все сервисы используют общий InMemoryDatabase вместо PostgreSQL/Prisma.
- Оплата Stars и pgvector эмулируются.
- SSE и реальный OpenRouter не подключены — ответы ассистента генерируются программно, но сохраняют структуру действий.
