Ниже — структурированные функциональные требования (FRD) для разработки сервиса «Mini App + бот» (в стиле Janitor AI) с магазином предметов, подписками, пакетами и PWA‑режимом для локальной отладки.

Язык интерфейса: весь пользовательский интерфейс (Mini App, бот, PWA) — на русском. Админка может быть RU/EN.
Важное ограничение: голоса нет (никаких TTS/STT/звонков).

1) Общее

FR-GEN-01. Пользователь выбирает персонажа только в Telegram Mini App (далее — «приложение»), а общение происходит в боте.

FR-GEN-02. Админка доступна только сотрудникам/создателям: создание/редактирование персонажей, историй, предметов, цен, подписок, возвраты.

FR-GEN-03. Монетизация: подписки (уровни), пакеты (Story/Memory/Creator) и магазин предметов. Все оплаты в продакшне — Telegram Stars (XTR).

FR-GEN-04. Бесплатный слой — дневной лимит сообщений; подписки — безлимит (с «мягкой» защитой от абьюза).

FR-GEN-05. Память диалога: скользящее окно 4 пары «пользователь+ассистент» + сводка (summary); опционально долговременная семантическая память (Memory Pack или соответствующий тариф).

FR-GEN-06. SSE‑стриминг из LLM: в Telegram имитируем «печать» через периодические editMessageText (не чаще 1/с на чат).

FR-GEN-07. Вся локальная разработка и запуск сервисов выполняется через единый `docker-compose` (одна команда поднимает БД, Redis, API, бот, worker, PWA); прямой запуск без Compose запрещён в продакшен-сборках.

2) Роли

Пользователь: выбирает персонажа, покупает пакеты/предметы, оформляет подписки, общается с ботом.

Админ: управляет персонажами, сюжетами, предметами, ценами, модерацией, возвратами, просматривает отчёты.

Креатор (опционально v2): публикует персонажей «creator‑only».

3) Пользовательские сценарии (верхний уровень)

Выбор персонажа в Mini App → создание диалога → открытие бота по deep‑link ?start=<dialog_id>.

Чат: отправка сообщения, получение стрим‑ответа; контекст = персонаж + (сюжет) + summary + последние 4 пары + (факты памяти при наличии).

Покупка: подписки/пакеты/предметы — через инвойсы XTR; успешная оплата немедленно выдаёт право/предмет.

Гейты сюжета: узлы, требующие предмет/флаг; при отсутствии — предложение купить предмет; после покупки — продолжение ветки.

4) Mini App (RU) — Каталог, Диалоги, Магазин

FR-APP-01. Экран каталога: список персонажей с поиском/фильтрами; отображать пейволлы (premium/creator‑only/платные арки).

FR-APP-02. Карточка персонажа: описание, тэги, видимые арки/эпизоды (Story Pack помечены).

FR-APP-03. Создание диалога: POST /api/dialogs (в ответ — dialog_id и deep‑link в бота).

FR-APP-04. Экран «Магазин»: список предметов по категориям (consumable/key/booster/cosmetic/utility), цена в ★XTR, скидка по тарифу, наличие у пользователя.

FR-APP-05. Экран «Покупки»: подписки и пакеты (Story/Memory/Creator), цены в XTR, кнопка «Оплатить».

FR-APP-06. Экран «Лимит»: отображать остаток дневного лимита/статус безлимита; CTA на апгрейд.

Критерии приёмки:

Каталог скрывает «creator‑only» без Creator Pack.

После создания диалога появляется рабочая ссылка для открытия бота.

При попытке открыть платную ветку без ключа — кнопка «Купить предмет».

5) Бот — Чат и UX

FR-BOT-01. Обработка входящих сообщений, проверка лимитов/прав перед постановкой в обработку.

FR-BOT-02. Плейсхолдер «печатает…» и стрим‑редакции одного сообщения ≈1 раз/с (при 429 — бэкофф).

FR-BOT-03. Длинные ответы — «Показать ещё» (доклейка).

FR-BOT-04. Inline‑кнопки: «Купить предмет», «Купить пакет», «Оформить подписку».

FR-BOT-05. Сообщения об исчерпании дневного лимита с CTA на подписку.

Критерии приёмки:

На 51‑м сообщении (если лимит=50) бот не отправляет запрос к LLM и предлагает оплату.

После покупки сюжетного ключа бот автопродолжает ветку без повторного ввода.

6) Платежи (Stars/XTR)

FR-PAY-01. Все цифровые товары в проде — через Stars: sendInvoice/createInvoiceLink, pre_checkout_query (≤10с), successful_payment, хранение telegram_payment_charge_id.

FR-PAY-02. Подписки: ежемесячные (единственный период), активный статус даёт безлимит и перки уровня.

FR-PAY-03. Пакеты: Story/Memory/Creator — разовые покупки; сразу выдают права.

FR-PAY-04. Магазин предметов: покупка отдельного предмета — инвойс XTR; успешная оплата → предмет в инвентарь.

FR-PAY-05. Возвраты: по запросу админа — отменяем право/предмет, помечаем транзакцию refunded.

FR-PAY-06. В dev/PWA‑режиме — mock‑платежи (без реального Stars), с явной пометкой в UI.

Критерии приёмки:

После successful_payment право/предмет видны без перезапуска.

Refund снимает право/предмет и информирует пользователя.

7) Подписки и лимиты

FR-SUB-01. Тарифы:

Free: дневной лимит; контекст = summary + 4 пары; без векторной памяти.

Plus: безлимит; vector top‑k=3; скидка в магазине 5%.

Pro: безлимит; vector top‑k=5; увеличенный бюджет summary; скидка 10%; приоритет ответа.

Ultra: безлимит; vector top‑k=7; повышенный TTL эффектов; доступ к creator‑only; скидка 15%; наивысший приоритет.

FR-SUB-02. «Мягкая» защита от абьюза: софт‑кэп (напр. 2000 сообщений/сутки) → предупреждение, но без жёсткой блокировки.

FR-SUB-03. Цена/скидки на предметы зависят от уровня подписки.

Критерии приёмки:

Смена тарифа мгновенно меняет скидку и доступ к аркам/персонажам.

Превышение софт‑кэпа только уведомляет.

8) Пакеты (Story, Memory, Creator)

FR-PACK-01. Story Pack: открывает платные арки/эпизоды выбранных персонажей.

FR-PACK-02. Memory Pack: включает долговременную память (векторку), повышает top‑k/TTL в рамках настроек.

FR-PACK-03. Creator Pack: доступ к персонажам с видимостью creator.

FR-PACK-04. Пакеты — разовая покупка (или ограниченный срок, если задан expires_at).

Критерии приёмки:

После покупки Story Pack платные узлы становятся проходимыми.

Memory Pack добавляет факты в промпт (видно в логах составления контекста).

9) Магазин предметов и эффекты

FR-SHOP-01. Категории: consumable, key, booster, cosmetic, utility.

FR-SHOP-02. Предмет описывается полем effect (JSON), напр.:

memory.boost { topK:+3, ttl_messages:10 }

llm.fastlane { model:"premium", ttl_messages:5 }

gate.key { key:"asylum13" }

style.mood { mood:"mystery", ttl_hours:24 }

FR-SHOP-03. Покупка предмета пополняет инвентарь; расходуемые предметы уменьшают qty. Все операции идемпотентны.

FR-SHOP-04. Ветвления сюжета могут требовать предмет/флаг (StoryGate.requires), бот должен предложить покупку.

FR-SHOP-05. Эффекты применяются поверх базовых правил контекста (см. §10) и имеют TTL (по сообщениям или по времени).

Критерии приёмки:

Покупка «Сюжетного ключа: Приют‑13» снимает блокировку узла и переводит в следующую сцену.

«Кристалл Памяти» увеличивает фактический top‑k на указанный TTL сообщений.

10) Диалог, контекст и память

FR-DLG-01. Состав промпта при генерации (в этом порядке):

Persona (активная версия карточки персонажа),

Story (директивы активной арки/сцены, если есть),

Summary (короткая сводка диалога),

Последние 4 пары U/A (итого 8 сообщений),

(Опционально) top‑k фактов из долговременной памяти (если включена Memory Pack или тариф ≥ Plus).

FR-DLG-02. Summary пересчитывается после каждого ответа ассистента.

FR-DLG-03. Лимиты токенов: при нехватке — сначала урезается число фактов, затем длина summary; persona/story не режутся.

FR-DLG-04. Action‑envelope (структурированный JSON от LLM) с полями:

user_visible_text — RU‑ответ,

actions[] — OFFER_ITEM | CONSUME_ITEM | SET_FLAG и т. д.
Неверный JSON → игнор действий, но показываем user_visible_text.

FR-DLG-05. SSE‑стриминг: буферизация токенов и «редакции» не чаще 1/с/чат; при 429 — бэкофф.

Критерии приёмки:

В логах видно: persona → story → summary → ровно 4 пары → (факты при наличии).

После 10 сообщений TTL «Кристалла Памяти» эффект пропадает автоматически.

11) Контент по умолчанию (сидинг)

FR-CONT-01. Создать 2 предустановленных персонажа:

Арина Климова, Куратор Архива (нуар, фактология). Арки: tram_legend, asylum13 (ключ‑гейт), silver_key.

Илья «Вектор» Силантьев (кибер‑нуар). Арки: ghost_net, depot_echo.

FR-CONT-02. Добавить предметы:

plot-key-asylum13 (gate.key),

memory-crystal (memory.boost),

fastlane (llm.fastlane),

(опционально) style-mood-* (cosmetic).

FR-CONT-03. Узел‑пример с гейтом «Приют‑13»: при отсутствии ключа — оффер покупки.

Критерии приёмки:

После сидинга можно пройти ветку «Приют‑13», купив ключ.

Без ключа узел недоступен и предлагает покупку.

12) Админка

FR-ADM-01. Персонажи: CRUD, версии, публикация, видимость (public|premium|creator), статус (draft|live).

FR-ADM-02. Истории: CRUD арок; узлы, requires, связка офферов предметов.

FR-ADM-03. Предметы: CRUD, эффекты (JSON‑редактор), цены (XTR), скидки по тарифам.

FR-ADM-04. Пакеты/Подписки: настройка цен, связей с правами.

FR-ADM-05. Платежи/Возвраты: просмотр транзакций, кнопка «Refund», автоматическая ревокация прав/инвентаря.

FR-ADM-06. Отчёты: использование токенов/стоимость/ошибки; выгрузка CSV.

Критерии приёмки:

Изменение активной версии персонажа влияет на новые ответы сразу.

Refund снимает право/предмет не дольше чем за 60 секунд.

13) PWA‑режим для локальной отладки

FR-PWA-01. Отдельная сборка PWA (манифест, service worker) с теми же экранами, что в Mini App.

FR-PWA-02. Оплаты — только mock; на всех экранах виден баннер предупреждения («реальные платежи — в Telegram»).

FR-PWA-03. В mock‑платеже разработчик может «подтвердить оплату»; сервис выдаёт право/предмет как при настоящей оплате (с пометкой источника).

Критерии приёмки:

В PWA нельзя вызвать реальный инвойс Stars.

Mock‑покупка корректно даёт доступ/инвентарь.

14) Безопасность, модерация, ошибки

FR-SEC-01. Mini App: сервер валидирует initData (HMAC), отклоняет подделки.

FR-SEC-02. Журналы без PII; токены/ключи — в секрете; роли в админке.

FR-MOD-01. Базовые фильтры текста (регэкспы/простая токс‑модель) на вход/выход; флаги в логах.

FR-ERR-01. При ошибке LLM/сетевой — вежливое RU‑сообщение и кнопка «Повторить»; повтор через очередь; DLQ после 3 неудач.

15) Наблюдаемость

FR-OBS-01. Метрики: rps, ошибки, p95 латентность, 429/бэкофф, токены/стоимость, hit‑rate кэша промптов.

FR-OBS-02. Трейсы: webhook → очередь → оркестратор → OpenRouter → ответы бота.

FR-OBS-03. Аудит: кто/когда менял персонажа/историю/цену.

16) Конфигурация (функциональная)

Дневной лимит по умолчанию: QUOTA_DAILY_LIMIT (напр., 50).

Софт‑кэп безлимита: SUBSCRIPTION_UNLIMITED_SOFTCAP (напр., 2000).

Скидки магазина по тарифам: Plus 5%, Pro 10%, Ultra 15%.

TTL эффектов по умолчанию: memory.boost (10 сообщений), fastlane (5 сообщений), style.mood (24 ч).

Мод показа: APP_MODE=telegram|miniappprod|pwa-dev; платежи: PAYMENTS_MODE=stars|mock.

17) Критерии приёмки (интеграционные)

Лимит/подписка. Free‑пользователь после достижения лимита не может вызвать LLM; подписка (Pro) даёт безлимит, скидку 10% и доступ к premium‑аркам.

Сюжетный гейт. Без plot-key-asylum13 узел закрыт; после покупки — автоматически открывается и продолжается сцена.

Эффект памяти. memory-crystal повышает фактический top‑k на +3 ровно на 10 сообщений; далее возвращается прежнее значение.

Action‑envelope. Если LLM вернул OFFER_ITEM, бот показывает кнопку покупки; при CONSUME_ITEM — уменьшается qty и применяются эффекты.

Refund. Возврат по транзакции пакета убирает право (Story/Memory/Creator) и скрывает доступный контент.

PWA. В PWA‑режиме платёж — только mock; выдача прав/предметов помечена source=pwa-mock.

18) Необходимые артефакты на выходе

Сидинг БД: 2 персонажа (Арина/Вектор), арки, предметы, гейты, цены.

RU‑копирайт для основных экранов и системных сообщений.

JSON‑схема Action‑envelope (валидатор на бэкенде).

Postman/Insomnia‑коллекция для публичных API.

Инструкции по локальному запуску (PWA dev, mock‑платежи) и по подключению вебхука бота.
