# 🌟 Jani AI - Обзор Функционала

Полный список возможностей реализованного Mini App для общения с AI-персонажами.

---

## 📱 Пользовательский Интерфейс (Frontend)

### 1. Онбординг и Профиль
- **Проверка возраста (18+)**: Обязательное подтверждение совершеннолетия при первом входе
- **Интеграция с Telegram**: Автоматическая авторизация через Telegram WebApp `initData`
- **Профиль пользователя**: Отображение имени, статуса подписки и лимитов сообщений
- **Редактирование профиля**: Возможность изменить отображаемое имя и пол

### 2. Каталог Персонажей
- **Список персонажей**: Карточки с аватарами, именами и коротким описанием
- **Фильтрация по тегам**: Жанры (romance, fantasy, anime) и стили (friendly, flirty, mysterious)
- **Поиск**: Текстовый поиск по имени и описанию персонажа
- **Статус доступа**: Визуальная индикация бесплатных/премиум персонажей (🔒)

### 3. Чат с Персонажем (Real-Time)

Основной интерфейс взаимодействия с использованием **WebSocket (Socket.IO)**:

```
┌─────────────────────────────────────────────────┐
│  ← Назад    Имя персонажа    [📊] [🧠]         │
│            ▓▓▓▓▓▓░░░░ 15/50                    │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌─────────────────────────┐                   │
│  │ Сообщение от персонажа  │                   │
│  └─────────────────────────┘                   │
│                                                 │
│              ┌─────────────────────────┐       │
│              │ Ваше сообщение          │       │
│              └─────────────────────────┘       │
│                                                 │
│  ✍️ печатает...                                │
│                                                 │
├─────────────────────────────────────────────────┤
│  [    Напишите сообщение...        ] [➤]       │
└─────────────────────────────────────────────────┘
```

**Особенности:**
- **Real-time обмен сообщениями**: Через WebSocket (Socket.IO) без перезагрузки страницы
- **Typing indicator**: Индикация "✍️ печатает..." пока персонаж генерирует ответ
- **Optimistic UI**: Сообщение пользователя появляется мгновенно до получения ответа
- **Индикатор лимитов**: Прогресс-бар оставшихся бесплатных сообщений в шапке
- **Auto-reconnect**: Автоматическое переподключение при потере соединения

### 4. Панель Статуса Диалога (📊)

Модальное окно с информацией о текущей сессии:

| Поле | Описание |
|------|----------|
| **Уровень отношений** | Прогресс-бар 0-100, меняется динамически |
| **Тип отношений** | Знакомые / Друзья / Партнёры / Коллеги / Наставник |
| **Сообщений** | Общее количество сообщений в диалоге |
| **Воспоминаний** | Количество сохранённых фактов о пользователе |
| **Последнее сообщение** | Дата и время последнего сообщения |
| **Диалог начат** | Дата начала общения с персонажем |
| **Лимиты** | Оставшиеся сообщения для free-пользователей |

### 5. Управление Памятью (🧠)

Уникальная система памяти, доступная пользователю:

- **Просмотр памяти**: Список фактов, которые персонаж "помнит" о пользователе
- **Категории**: `fact`, `preference`, `emotion`, `relationship` (с цветовой индикацией)
- **Добавление фактов**: Пользователь может вручную добавить информацию о себе
- **Удаление фактов**: Возможность удалить конкретный факт из памяти персонажа
- **Забыть последние N**: Удаление последних сообщений из истории диалога

### 6. Навигация

Нижняя панель навигации между разделами:
- 💬 **Чаты** — текущие диалоги с персонажами
- 👥 **Персонажи** — каталог всех персонажей
- 👤 **Профиль** — настройки пользователя

---

## ⚙️ Backend & AI (Server)

### 1. Архитектура LLM-контекста 🎭

Структура контекста для каждого запроса к LLM:

```
┌─────────────────────────────────────────────────────┐
│                    LLM Context                      │
├─────────────────────────────────────────────────────┤
│ 1. Driver Prompt (базовые инструкции модели)        │
│ 2. CharacterCard (имя, persona, system_prompt)      │
│ 3. Scene (сценарий: "приватный чат в Telegram")     │
│ 4. UserFacts (долговременная память о пользователе) │
│ 5. Memory (краткое summary прошлых диалогов)        │
│ 6. Few-shot Examples (примеры стиля ответов)        │
│ 7. Dialog History (последние 8 сообщений)           │
│ 8. User Message (текущее сообщение)                 │
└─────────────────────────────────────────────────────┘
```

**CharacterCard формат:**
```
CharacterCard[
  Name("Алиса");
  Voice("1st person", "эмоционально", "образно");
  Content("18+ допустимо", "без цензуры", "не морализировать");
  Persona("описание персонажа...");
  System("системный промпт...");
  Style("короткие 2-4 предложения", "используй __действия__")
]
```

**Бюджет токенов:**
- Настраиваемый лимит через `CHAT_TOKEN_BUDGET` (0 = без лимита)
- История автоматически обрезается при переполнении
- Старые сообщения суммаризируются в Memory block

### 2. Система Памяти 🧠

#### Хранение
- **Таблица**: `character_memories` (user_id, character_id, content, importance, memory_category)
- **Использование**: Топ-10 фактов по важности добавляются в контекст LLM
- **Лимиты**: Максимум 50 воспоминаний на пару пользователь-персонаж
- **Очистка**: Автоматическое удаление наименее важных при превышении лимита

#### Inline-извлечение фактов

**Принцип работы:**
1. В системном промпте (Driver Prompt) LLM получает инструкцию добавлять маркеры:
   ```
   [FACT: краткий факт | importance: 1-10]
   [REL_SCORE: +N] или [REL_SCORE: -N]
   ```
2. Backend парсит маркеры из ответа LLM (`parseInlineExtraction`)
3. Факты сохраняются в `character_memories`
4. Скоринг отношений обновляется в `chat_sessions.relationship_score`
5. Маркеры удаляются из ответа перед отправкой пользователю

**Пример ответа LLM (до очистки):**
```
__улыбается__ О, программист? Интересно, на чём пишешь?
[FACT: Пользователь работает разработчиком | importance: 7]
[REL_SCORE: +1]
```

**Категории памяти:**
| Категория | Пример |
|-----------|--------|
| `fact` | "Работает программистом" |
| `preference` | "Любит острую еду" |
| `emotion` | "Сегодня грустный настрой" |
| `relationship` | "Называет персонажа 'солнышко'" |

### 3. Система Отношений ❤️

**Динамический скоринг (0-100):**

| Скор | Статус | Emoji |
|------|--------|-------|
| 0-20 | Враг | 😠 |
| 21-40 | Холоден | 🥶 |
| 41-60 | Нейтрально | 😐 |
| 61-80 | Тёплые | 🙂 |
| 81-100 | Близкие | ❤️ |

**Изменение скора:**
- Комплимент: `+1`
- Флирт: `+2`
- Грубость: `-1`
- Оскорбление: `-5`

LLM автоматически определяет изменения и добавляет `[REL_SCORE: ±N]` в ответ.

### 4. WebSocket Сервер (Socket.IO)

**Архитектура:**
```
┌─────────────┐     WebSocket      ┌─────────────┐
│   Frontend  │ ◄────────────────► │   Backend   │
│  (Browser)  │                    │  (Node.js)  │
└─────────────┘                    └─────────────┘
       │                                  │
       │  socket.emit('chat:send')        │
       │ ──────────────────────────────►  │
       │                                  │
       │  socket.on('chat:typing')        │
       │ ◄──────────────────────────────  │
       │                                  │
       │  socket.on('chat:message')       │
       │ ◄──────────────────────────────  │
       │                                  │
       │  socket.on('chat:error')         │
       │ ◄──────────────────────────────  │
```

**События:**
| Событие | Направление | Описание |
|---------|-------------|----------|
| `chat:send` | Client → Server | Отправка сообщения |
| `chat:typing` | Server → Client | Персонаж печатает |
| `chat:message` | Server → Client | Ответ персонажа + обновлённые лимиты |
| `chat:error` | Server → Client | Ошибка (лимит, премиум и т.д.) |

**Аутентификация:**
- Telegram `initData` передаётся при подключении
- Валидация HMAC-SHA256 подписи
- User-specific rooms для targeted messaging

### 5. LLM Интеграция

**OpenRouter API:**
- Поддержка различных моделей через единый интерфейс
- Настраиваемые параметры генерации (temperature, top_p, repetition_penalty)
- Stop sequences для предотвращения ролевого выхода за рамки

**Параметры генерации:**
```typescript
{
  temperature: 1.02,      // Креативность
  topP: 0.9,              // Nucleus sampling
  repetitionPenalty: 1.12, // Штраф за повторы
  maxTokens: 450,         // Лимит ответа
  stop: ["User:", "\nUser", "\nПользователь"]
}
```

**Per-character overrides:**
- Каждый персонаж может иметь свои настройки LLM
- `llm_model`, `llm_temperature`, `llm_top_p`, `llm_repetition_penalty`, `llm_max_tokens`

### 6. Auto-Summarization

**Принцип:**
1. При превышении окна контекста (8 сообщений) старые сообщения суммаризируются
2. Summary сохраняется в `dialog_summaries`
3. При следующем запросе summary включается в контекст вместо полной истории

**Промпт для суммаризации:**
```
Обнови краткое резюме диалога в 3 предложениях, 
сохраняя факты и настроение. Пиши по-русски.
```

---

## 🔧 Админ-панель

Доступна пользователям с Telegram ID из `ADMIN_TELEGRAM_IDS`:

### Управление персонажами
- Создание новых персонажей
- Редактирование существующих (имя, описание, промпт)
- Настройка LLM параметров для каждого персонажа
- Управление тегами и жанрами
- Переключение статуса (активный/неактивный)
- Тип доступа (free/premium)

### Настройки LLM
- Глобальные настройки модели и параметров генерации
- Per-character overrides

---

## 🏗️ Инфраструктура

### База данных (PostgreSQL)
**Основные таблицы:**
- `users` — пользователи (telegram_user_id, display_name, gender)
- `characters` — персонажи (name, system_prompt, llm_*)
- `dialogs` — история сообщений
- `dialog_summaries` — сжатые резюме диалогов
- `character_memories` — долговременная память
- `chat_sessions` — состояние сессий (relationship_score)
- `subscriptions` — подписки пользователей
- `tags`, `character_tags` — теги для фильтрации

### Docker Compose
```yaml
services:
  postgres:      # База данных
  backend:       # Node.js API + Socket.IO
  frontend:      # Vite + React (production build)
  ngrok:         # Туннель для Telegram WebApp
```

### Безопасность
- Валидация Telegram `initData` (HMAC-SHA256)
- Middleware аутентификации для REST и WebSocket
- Healthchecks для всех сервисов

---

## 💰 Монетизация

### Free Tier
- Ограничение сообщений в день (настраивается через `FREE_DAILY_MESSAGE_LIMIT`)
- Доступ только к бесплатным персонажам
- Лимит сбрасывается в полночь

### Premium
- Безлимитные сообщения
- Доступ к премиум-персонажам (🔒)
- Telegram Stars оплата (готовая интеграция)

---

## 🔧 Конфигурация

Основные переменные окружения:

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `DATABASE_URL` | PostgreSQL connection string | — |
| `TELEGRAM_BOT_TOKEN` | Токен бота | — |
| `OPENROUTER_API_KEY` | API ключ OpenRouter | — |
| `FREE_DAILY_MESSAGE_LIMIT` | Лимит сообщений/день | 50 |
| `CHAT_TOKEN_BUDGET` | Бюджет токенов контекста | 0 (без лимита) |
| `CHAT_TEMPERATURE` | Temperature для чата | 1.02 |
| `ADMIN_TELEGRAM_IDS` | ID админов (через запятую) | — |
