# 🌟 Jani AI - Обзор Функционала

Полный список возможностей реализованного Mini App для общения с AI-персонажами.

---

## 📱 Пользовательский Интерфейс (Frontend)

### 1. Онбординг и Профиль
- **Проверка возраста (18+)**: Обязательное подтверждение совершеннолетия при первом входе
- **Интеграция с Telegram**: Автоматическая авторизация через Telegram WebApp `initData`
- **Профиль пользователя**: Отображение имени, никнейма, статуса подписки и лимитов сообщений
- **Редактирование профиля**: Возможность изменить отображаемое имя, никнейм и пол

### 2. Каталог Персонажей
- **Список персонажей**: Карточки с аватарами, именами и коротким описанием
- **Фильтрация по тегам**: Теги отображаются горизонтально над списком, клик фильтрует персонажей
- **Кросс-фильтрация**: Можно выбрать несколько тегов одновременно
- **Поиск**: Текстовый поиск по имени и описанию персонажа
- **Статус доступа**: Визуальная индикация бесплатных/премиум персонажей (🔒)
- **Автор и рейтинг**: Отображение автора персонажа и количества лайков

### 3. Чат с Персонажем (Real-Time)

Основной интерфейс взаимодействия с использованием **WebSocket (Socket.IO)**:

```
┌─────────────────────────────────────────────────┐
│  ← Назад    Имя персонажа    [📊] [🧠]         │
│            ▓▓▓▓▓▓░░░░ 15/50                    │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌─────────────────────────┐                   │
│  │ Сообщение от персонажа  │                   │
│  └─────────────────────────┘                   │
│                                                 │
│              ┌─────────────────────────┐       │
│              │ Ваше сообщение          │       │
│              └─────────────────────────┘       │
│                                                 │
│  ...                                │
│                                                 │
├─────────────────────────────────────────────────┤
│  [    Напишите сообщение...        ] [➤]       │
└─────────────────────────────────────────────────┘
```

**Особенности:**
- **Real-time обмен сообщениями**: Через WebSocket (Socket.IO) без перезагрузки страницы
- **Typing indicator**: Индикация "..." пока персонаж генерирует ответ
- **Optimistic UI**: Сообщение пользователя появляется мгновенно до получения ответа
- **Индикатор лимитов**: Прогресс-бар оставшихся бесплатных сообщений в шапке
- **Auto-reconnect**: Автоматическое переподключение при потере соединения

### 4. Панель Эмоционального Состояния (📊)

Модальное окно с информацией о текущей сессии:

| Поле | Описание |
|------|----------|
| **Настроение** | Текущий mood персонажа с эмодзи (😏 Ревнивая, ❤️ Влюблённая) |
| **Близость** | Прогресс-бар 0-50, вычисляется из 3 измерений |
| **Влечение** | Прогресс-бар -50..+50 с цветовым градиентом |
| **Доверие** | Прогресс-бар -50..+50 с цветовым градиентом |
| **Привязанность** | Прогресс-бар -50..+50 с цветовым градиентом |
| **Динамика** | Кто доминирует в отношениях (👑/🙇) |
| **Сообщений** | Общее количество сообщений в диалоге |
| **Воспоминаний** | Количество сохранённых фактов о пользователе |

### 5. Управление Памятью (🧠)

Уникальная система памяти, доступная пользователю:

- **Просмотр памяти**: Список фактов, которые персонаж "помнит" о пользователе
- **Добавление фактов**: Пользователь может вручную добавить информацию о себе
- **Удаление фактов**: Возможность удалить конкретный факт из памяти персонажа
- **Забыть последние N**: Удаление последних сообщений из истории диалога

### 6. Рейтинг Персонажей

- **Лайк/Дизлайк**: Пользователь может поставить оценку персонажу
- **Отображение**: Количество лайков видно в карточке персонажа
- **Изменение оценки**: Можно изменить или убрать свою оценку

### 7. Навигация

Нижняя панель навигации между разделами:
- 💬 **Чаты** — текущие диалоги с персонажами
- 👥 **Персонажи** — каталог всех персонажей
- 👤 **Профиль** — настройки пользователя

---

## ⚙️ Backend & AI (Server)

### 1. Архитектура LLM-контекста 🎭

Структура контекста для каждого запроса к LLM:

```
┌─────────────────────────────────────────────────────┐
│                    LLM Context                      │
├─────────────────────────────────────────────────────┤
│ 1. Driver Prompt (базовые инструкции модели)        │
│ 2. CharacterCard (имя, persona, system_prompt)      │
│ 3. Scene (сценарий: "приватный чат в Telegram")     │
│ 4. UserFacts (долговременная память о пользователе) │
│ 5. Memory (краткое summary прошлых диалогов)        │
│ 6. Dialog History (последние 8 сообщений)           │
│ 7. User Message (текущее сообщение)                 │
└─────────────────────────────────────────────────────┘
```

**CharacterCard формат:**
```
CharacterCard[
  Name("Алиса");
  Voice("1st person", "эмоционально", "образно");
  Content("18+ допустимо", "без цензуры", "не морализировать");
  Persona("описание персонажа...");
  System("системный промпт...");
  Style("короткие 2-4 предложения", "используй __действия__")
]
```

**Бюджет токенов:**
- Настраиваемый лимит через `CHAT_TOKEN_BUDGET` (0 = без лимита)
- История автоматически обрезается при переполнении
- Старые сообщения суммаризируются в Memory block

### 2. Система Памяти 🧠

#### Хранение
- **Таблица**: `character_memories` (user_id, character_id, content, importance)
- **Использование**: Топ-10 фактов по важности добавляются в контекст LLM
- **Лимиты**: Максимум 50 воспоминаний на пару пользователь-персонаж
- **Очистка**: Автоматическое удаление наименее важных при превышении лимита

#### JSON Response Format

**Принцип работы:**
1. LLM обучен отвечать **только JSON объектом** с полями `reply` и `relationship_delta`
2. Backend парсит JSON ответ (`parseJsonResponse`)
3. Факты извлекаются во время периодической суммаризации (каждые 8 сообщений)
4. Эмоциональное состояние обновляется в `user_character_state`
5. Пользователь получает только текст из поля `reply`

**Формат ответа LLM:**
```json
{
  "reply": "__улыбается__ О, программист? Интересно, на чём пишешь?",
  "relationship_delta": 1
}
```

### 3. Система Эмоциональных Отношений ❤️

**Многомерная модель отношений** (вместо одного score 0-100):

| Измерение | Диапазон | Описание |
|-----------|----------|----------|
| **Attraction** (Влечение) | -50..+50 | Физическое влечение, флирт |
| **Trust** (Доверие) | -50..+50 | Открытость, честность |
| **Affection** (Привязанность) | -50..+50 | Забота, привязанность |
| **Dominance** | -50..+50 | -50=пользователь ведёт, +50=персонаж доминирует |

**Вычисляемый Closeness (близость):**
```typescript
const closeness = Math.max(0, (attraction + trust + affection) / 3); // 0-50
```

**Mood персонажа (JSONB):**
```json
{"primary": "jealous", "secondary": "aroused", "intensity": 7}
```

Доступные настроения: LLM генерирует mood как свободный текст на русском (игривая, задумчивый, кокетливая и т.д.)

**JSON формат ответа LLM:**
```json
{
  "reply": "__вздыхает, прижимаясь ближе__ Ты заставляешь моё сердце биться быстрее...",
  "thoughts": "*Чёрт, я влипаю. Не должен был так открываться...*",
  "relationship_delta": {
    "attraction": 6,
    "trust": 4,
    "affection": 8,
    "dominance": -3
  },
  "mood": "vulnerable"
}
```

**Инструкции для LLM:**
- **Сенсорные детали**: запахи, звуки, прикосновения, текстуры
- **Телесные эмоции**: сердце стучит, дыхание учащается, мурашки
- **Уязвимость**: при высоком trust — делится страхами, мечтами, прошлым
- **Thoughts**: скрытые мысли персонажа (опционально, показываются курсивом)

### 4. WebSocket Сервер (Socket.IO)

**Архитектура:**
```
┌─────────────┐     WebSocket      ┌─────────────┐
│   Frontend  │ ◄────────────────► │   Backend   │
│  (Browser)  │                    │  (Node.js)  │
└─────────────┘                    └─────────────┘
       │                                  │
       │  socket.emit('chat:send')        │
       │ ──────────────────────────────►  │
       │                                  │
       │  socket.on('chat:typing')        │
       │ ◄──────────────────────────────  │
       │                                  │
       │  socket.on('chat:message')       │
       │ ◄──────────────────────────────  │
       │                                  │
       │  socket.on('chat:error')         │
       │ ◄──────────────────────────────  │
```

**События:**
| Событие | Направление | Описание |
|---------|-------------|----------|
| `chat:send` | Client → Server | Отправка сообщения |
| `chat:typing` | Server → Client | Персонаж печатает |
| `chat:message` | Server → Client | Ответ персонажа + обновлённые лимиты |
| `chat:error` | Server → Client | Ошибка (лимит, премиум и т.д.) |

**Аутентификация:**
- Telegram `initData` передаётся при подключении через `socket.io.auth`
- Валидация HMAC-SHA256 подписи
- User-specific rooms для targeted messaging

### 5. LLM Интеграция

**Поддерживаемые провайдеры:**
- **OpenRouter API** — универсальный доступ к различным моделям
- **Gemini API** — прямая интеграция с Google Gemini
- **OpenAI API** — прямая интеграция с OpenAI GPT моделями

**Выбор провайдера:**
- Админ устанавливает провайдер для каждого персонажа (`llm_provider`)
- Пользователь может переопределить модель для своей сессии
- Глобальные настройки суммаризации в `app_settings`

**Параметры генерации:**
```typescript
{
  temperature: 1.02,      // Креативность
  topP: 0.9,              // Nucleus sampling
  repetitionPenalty: 1.12, // Штраф за повторы
  stop: ["User:", "\nUser", "\nПользователь"]
}
```

**Per-character overrides:**
- Каждый персонаж может иметь свои настройки LLM
- `llm_provider`, `llm_model`, `llm_temperature`, `llm_top_p`, `llm_repetition_penalty`
- Ограничение по токенам (maxTokens) убрано для ответов — используется лимит модели

### 6. Auto-Summarization (Optimized)

**Принцип:**
1. **Интервальная саммаризация**: Срабатывает каждые 8 сообщений (размер окна контекста), когда они выходят из "горячего" конткста.
2. **Инкрементальное обновление**: Новые сообщения добавляются к существующему summary, избегая полной перегенерации.
3. **Эффективность**: Количество вызовов LLM для саммаризации сокращено на ~90% (1 вызов на 8 сообщений).
4. Summary сохраняется в `dialog_summaries` и автоматически подгружается в context window.
5. **Глобальные настройки**: Провайдер и модель для суммаризации настраиваются отдельно в админ-панели.

**Промпт для суммаризации:**
```
Обнови краткое резюме диалога в 3-4 предложениях, 
сохраняя факты и настроение. Пиши по-русски.
```

---

## 🔧 Админ-панель

Доступна пользователям с Telegram ID из `ADMIN_TELEGRAM_IDS`:

### Управление персонажами
- **Создание** новых персонажей с указанием всех параметров
- **Редактирование** существующих (имя, описание, промпт)
- **Загрузка изображений** (аватаров) для персонажей
- **Настройка LLM** параметров для каждого персонажа
- **Управление тегами** — назначение и создание тегов
- **Переключение статуса** (активный/неактивный)
- **Тип доступа** (free/premium)
- **Начальные значения** отношений (attraction, trust, affection, dominance)

### Настройки LLM
- Глобальные настройки провайдера и модели для суммаризации
- Per-character overrides для чата

### Управление загрузками
- Просмотр всех загруженных файлов
- Удаление неиспользуемых файлов
- Защита от удаления используемых файлов

### Управление тегами
- Создание новых тегов
- Удаление существующих тегов
- Просмотр всех тегов

---

## 🏗️ Инфраструктура

### База данных (PostgreSQL)
**Основные таблицы:**
- `users` — пользователи (telegram_user_id, display_name, gender, nickname)
- `characters` — персонажи (name, system_prompt, llm_*, created_by)
- `dialogs` — история сообщений
- `dialog_summaries` — сжатые резюме диалогов (summary_text, summarized_message_count)
- `character_memories` — долговременная память
- `chat_sessions` — состояние сессий (last_message_at, llm_model)
- `user_character_state` — эмоциональное состояние (attraction, trust, mood)
- `subscriptions` — подписки пользователей
- `tags`, `character_tags` — теги для фильтрации
- `character_ratings` — лайки/дизлайки персонажей
- `app_settings` — глобальные настройки приложения

### Docker Compose
```yaml
services:
  postgres:      # База данных
  backend:       # Node.js API + Socket.IO
  frontend:      # Vite + React (production build)
  ngrok:         # Туннель для Telegram WebApp
```

### Безопасность
- Валидация Telegram `initData` (HMAC-SHA256)
- Middleware аутентификации для REST и WebSocket
- Healthchecks для всех сервисов
- Валидация типа файла при загрузке (magic bytes)
- Защита от path traversal при работе с файлами

---

## 💰 Монетизация

### Free Tier
- Ограничение сообщений в день (настраивается через `FREE_DAILY_MESSAGE_LIMIT`, можно отключить через `ENABLE_MESSAGE_LIMIT=false`)
- Доступ только к бесплатным персонажам
- Лимит сбрасывается в полночь

### Premium
- Безлимитные сообщения
- Доступ к премиум-персонажам (🔒)
- Telegram Stars оплата (готовая интеграция)

---

## 🔧 Конфигурация

Основные переменные окружения:

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `DATABASE_URL` | PostgreSQL connection string | — |
| `TELEGRAM_BOT_TOKEN` | Токен бота | — |
| `OPENROUTER_API_KEY` | API ключ OpenRouter | — |
| `GEMINI_API_KEY` | API ключ Gemini | — |
| `OPENAI_API_KEY` | API ключ OpenAI | — |
| `FREE_DAILY_MESSAGE_LIMIT` | Лимит сообщений/день | 50 |
| `ENABLE_MESSAGE_LIMIT` | Применять лимит сообщений | true |
| `CHAT_TOKEN_BUDGET` | Бюджет токенов контекста | 0 (без лимита) |
| `CHAT_TEMPERATURE` | Temperature для чата | 1.02 |
| `ADMIN_TELEGRAM_IDS` | ID админов (через запятую) | — |
