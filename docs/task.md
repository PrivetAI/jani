1. Общие сведения
1.1. Назначение системы

Система предназначена для общения пользователей с AI-персонажами в Telegram, включая развлекательное и сексуального характера общение (18+).

Функциональные компоненты:

Telegram Mini App (WebApp), доступный также как PWA.

Telegram-бот для ведения чата.

Бэкенд-сервис (Node.js) с API, интегрированный с LLM (OpenRouter).

Простая админ-панель для управления персонажами и просмотра статистики.

1.2. Цели проекта

Предоставить простой интерфейс выбора персонажа и перехода к чату в Telegram.

Реализовать монетизацию через подписку за Telegram Stars.

Обеспечить базовую админку для создания/редактирования персонажей и просмотра статистики.

1.3. Ограничения и допущения

Язык интерфейса и общения: только русский.

Контент: проект ориентирован на 18+ аудиторию (в т.ч. секстинг).

Канал общения: только текстовые сообщения.

Целевая нагрузка и отказоустойчивость на первом этапе явно не нормируются.

2. Архитектура и стек технологий
2.1. Компоненты

Бэкенд-сервис

Node.js.

REST API (JSON).

Обработчик Telegram Webhook.

Фронтенд

SPA (React/Vue/аналог).

Работа как:

Telegram WebApp (Mini App);

PWA (с PWA-манифестом и Service Worker).

Telegram-бот

Получает сообщения от пользователей.

Взаимодействует с бэкендом по HTTPS.

БД

Реляционная БД (PostgreSQL / MySQL).

Интеграция с LLM

OpenRouter API.

Отдельный модуль LLM-сервиса.

2.2. Разделение ответственности

Фронтенд: UI, авторизация через Telegram WebApp, работа с API.

Бэкенд: бизнес-логика, хранение данных, биллинг подписки, интеграция с Telegram и OpenRouter.

Бот: интерфейс чата, но вся логика через бэкенд.

3. Функциональные требования
3.1. Пользователь (конечный)
3.1.1. Идентификация и профиль

Пользователь идентифицируется по:

telegram_user_id;

username (ник).

В системе хранится:

telegram_user_id;

username;

статус подписки (none / active / expired);

дата окончания подписки (если есть);

последний выбранный персонаж.

3.1.2. Подписка и лимиты

Один тариф: Premium 30 дней.

Оплата: только через Telegram Stars.

Без подписки:

доступ только к персонажам с типом free;

лимит: 50 сообщений в день (на пользователя, суммарно по всем персонажам).

С подпиской:

доступ к персонажам free и premium;

безлимитный объём сообщений.

При истечении подписки:

статус expired;

доступ к премиум-персонажам и безлимитным сообщениям блокируется (жёсткий режим).

3.1.3. Общение и контекст

Пользователь общается с выбранным персонажем через Telegram-бот.

Для каждого пользователя и персонажа ведётся отдельная история.

Для генерации ответа LLM используется контекст:

последние 4 пары «сообщение пользователя — ответ бота»;

плюс системный промпт персонажа.

Контекст обновляется после каждого сообщения.

3.2. Mini App / PWA
3.2.1. Авторизация

Авторизация через Telegram WebApp (initData).

На бэкенде создаётся/обновляется запись пользователя (telegram_user_id, username).

3.2.2. Экран «Список персонажей»

Отображение всех активных персонажей:

аватар;

имя;

длинное описание (кратко, обрезка/превью);

бейдж «Премиум» для платных персонажей.

Отсутствуют поиск, фильтры и избранное.

3.2.3. Экран «Карточка персонажа»

Детальная информация:

аватар (крупнее);

имя;

полное описание.

бейдж «Бесплатный» / «Премиум».

Кнопка «Начать чат»:

открытие диалога с ботом:

t.me/<bot_username>?start=<character_id>.

3.2.4. Экран «Подписка»

Информация о тарифе Premium 30 дней:

цена в Telegram Stars;

преимущества: доступ к премиум-персонажам, безлимит сообщений.

Текущий статус:

активна / не активна;

дата окончания (если активна).

Кнопка «Оформить подписку»:

инициация оплаты через Telegram Stars.

Обработка успешной оплаты:

вызов backend-API;

создание/обновление записи подписки.

3.2.5. Экран «Профиль»

Отображение:

ник и telegram_user_id;

статус подписки и дата окончания;

последний выбранный персонаж (если есть).

Кнопки:

«Оформить/продлить подписку» (если подписка не активна);

«Открыть бота / продолжить чат» (с последним персонажем).

3.3. Telegram-бот
3.3.1. Команда /start

С параметром start=<character_id>:

сохранение выбранного персонажа для пользователя;

отправка приветственного сообщения: персонаж выбран, предложить написать первое сообщение.

Без параметра:

отправка сообщения с кнопкой «Открыть мини-приложение» (WebApp) для выбора персонажа.

3.3.2. Приём сообщений пользователя

Тип сообщений: текст.

Логика при получении текста:

Проверить, привязан ли к пользователю персонаж:

если нет — отправить сообщение с кнопкой открытия Mini App.

Проверить статус подписки и лимит:

если подписка отсутствует и дневной лимит 50 сообщений исчерпан:

отправить сообщение:

«Лимит исчерпан, оформите подписку»;

кнопка «Оформить подписку» (открытие Mini App на экране подписки).

Сформировать контекст (последние 4 пары сообщений для пользователя и выбранного персонажа).

Отправить запрос к LLM:

системный промпт = промпт персонажа;

сообщения контекста + текущее сообщение.

Отправить ответ LLM пользователю.

3.3.3. Кнопки в боте

Inline-кнопка:

«Открыть мини-приложение» (WebApp).

Других текстовых команд, кроме /start, не предусмотрено (управление через Mini App).

3.4. Админ-панель
3.4.1. Доступ

Авторизация по белому списку admin_telegram_ids:

запрос из фронтенда сопровождается Telegram-данными;

бэкенд проверяет, есть ли telegram_user_id в списке админов.

При отсутствии в белом списке — отказ в доступе.

3.4.2. Управление персонажами (CRUD)

Экран «Список персонажей»

Таблица:

ID;

имя;

тип (free / premium);

статус (активен / неактивен);

дата создания.

Действия:

создать;

редактировать;

деактивировать/активировать.

Экран «Редактирование/создание персонажа»

Поля:

Имя (строка);

Длинное описание (текст, видимое пользователю);

Аватар: загрузка изображения → URL;

Системный промпт (текст, используемый для LLM);

Тип доступа: free / premium;

Флаг активности: is_active (отображать в списке/нет).

3.4.3. Пользователи

Экран «Пользователи»

Таблица:

telegram_user_id;

username;

статус подписки (none / active / expired);

дата окончания подписки;

дата регистрации.

Ручного изменения подписок нет.

3.4.4. Статистика (простая)

Отображаемые показатели:

Общее количество зарегистрированных пользователей.

Общее количество активных подписок.

Количество сообщений за период (день/неделя/месяц).

Топ персонажей по:

количеству уникальных пользователей;

количеству сообщений.

4. Требования к данным и структуре БД (упрощённая модель)
4.1. Таблица users

id (PK)

telegram_user_id (unique)

username

created_at

4.2. Таблица subscriptions

id (PK)

user_id (FK → users)

status (active / expired)

start_at

end_at

created_at

4.3. Таблица characters

id (PK)

name

description_long

avatar_url

system_prompt

access_type (free / premium)

is_active (boolean)

created_at

4.4. Таблица dialogs

id (PK)

user_id (FK → users)

character_id (FK → characters)

role (user / assistant)

message_text

created_at

4.5. Таблица payments

id (PK)

user_id (FK → users)

amount_stars

telegram_payment_id / транзакционный ID

status (успешен / отменён / ошибка)

created_at

(Статистика может считаться агрегатами по этим данным без отдельной таблицы.)

5. Интеграция с LLM (OpenRouter)
5.1. LLM-сервис

Отдельный модуль/класс, например LLMService.

Метод:

generateReply(userId, characterId, messages[]).

5.2. Входные данные метода

Системный промпт персонажа (system_prompt).

Контекст:

до 4 последних пар сообщений (user/assistant) по этому пользователю и персонажу.

Новое сообщение пользователя.

5.3. Выходные данные

Строка — текст ответа персонажа.

6. Нефункциональные требования
6.1. Язык и локализация

Интерфейс Mini App, бота и админки — только русский язык.

6.2. Безопасность и доступ

Все API вызываются по HTTPS.

Админ-доступ только по белому списку Telegram ID.

Данные пользователей не передаются третьим сторонам, кроме:

Telegram (технически по Webhook);

OpenRouter (анонимные текстовые данные для генерации).

6.3. Логирование и бэкапы

Минимальное логирование ошибок бэкенда.

Бэкапы БД — базовая периодичность (может быть настроена отдельно, без жёстких требований в ТЗ).