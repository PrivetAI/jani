0. Общая концепция

Сервис: общение пользователя с AI-персонажами (в т.ч. развлекательное и сексуального характера, строго 18+).
Форматы:

Telegram Mini App (WebApp) + PWA (тот же фронтенд)

Telegram-бот, через которого идёт сам чат.

Монетизация: одна подписка на 30 дней за Telegram Stars → даёт:

доступ к премиум-персонажам;

снятие лимита сообщений (безлимит).

Без подписки:

только бесплатные персонажи;

ограничение: 50 сообщений в день (на пользователя).

1. Технологический стек и архитектура

Backend

Node.js (Express / NestJS).

REST API для:

mini app / PWA;

Telegram Webhook (бот).

Frontend (mini app / PWA)

SPA (например, React или Vue).

Использование Telegram WebApp API.

PWA-манифест + service worker.

База данных

PostgreSQL / MySQL.

Основные сущности: users, characters, subscriptions, dialogs, payments, stats.

LLM

Интеграция с OpenRouter.

Отдельный модуль/сервис для запросов к LLM.

2. Функциональные требования: пользовательская часть
2.1. Авторизация и профиль

Идентификация пользователя по:

telegram_user_id;

никнейм (username).

Дополнительной регистрации/пароля нет.

Профиль пользователя:

telegram_user_id, username;

статус подписки (active / expired / none);

дата окончания подписки;

последний выбранный персонаж.

2.2. Mini App / PWA – экраны

Экраны mini app (они же в PWA):

Список персонажей

Карточка персонажа:

аватар (загруженное изображение, хранится как URL);

имя;

длинное описание / «характер»;

бейдж «Премиум», если персонаж доступен только по подписке.

Нет поиска, фильтров, избранного.

Карточка персонажа (детальный просмотр)

Полный текст описания.

Бейдж «Бесплатный» / «Премиум».

Кнопка:

«Начать чат» → открывает диалог с ботом: t.me/<bot>?start=<character_id>.

Экран подписки

Описание одного тарифа:

название (например, «Premium 30 дней»);

стоимость в Telegram Stars;

преимущества: доступ к премиум-персонажам, безлимит сообщений.

Кнопка «Оформить подписку» → запуск оплаты через Telegram Stars.

Отображение текущего статуса:

активна/неактивна;

дата окончания (если активна).

Экран профиля

Ник и ID пользователя.

Статус подписки.

Кнопка «Оформить / продлить подписку» (если не активна).

Кнопка «Открыть бота» / «Продолжить диалог» (с последним персонажем).

2.3. Логика подписки

Подписка:

1 план: Premium, длительность 30 дней.

Оплата – только через Telegram Stars.

При успешной оплате:

создаётся/обновляется запись подписки;

end_at = now + 30 дней.

При проверке:

если now > end_at → подписка истекла, статус expired.

Без подписки:

доступ только к персонажам с типом free;

ограничение 50 сообщений в день (по всем персонажам суммарно).

С подпиской:

доступ ко всем персонажам (free + premium);

нет лимита сообщений.

Уведомлений о скором окончании подписки не делаем (по ТЗ).

2.4. Telegram-бот

Команда /start

Если приходит start=<character_id>:

сохранить выбранного персонажа пользователю;

отправить короткое приветствие («Вы выбрали персонажа X. Напишите сообщение.»).

Если параметр отсутствует:

отправить кнопку «Открыть мини-приложение» (WebApp) для выбора персонажа.

Диалог

Пользователь может отправлять только текст.

Бот:

проверяет, выбран ли персонаж для пользователя:

если нет → предложить открыть mini app (кнопка WebApp).

проверяет статус подписки и лимит сообщений:

если нет подписки и лимит 50/день исчерпан → сообщение о лимите + кнопка «Оформить подписку» (открывает mini app на экране подписки).

формирует контекст (последние 4 пары сообщение-ответ для данного пользователя и выбранного персонажа);

делает запрос к LLM (OpenRouter) с системным промптом персонажа;

отправляет ответ пользователю.

Кнопки в боте

Inline-кнопка:

«Открыть мини-приложение» – WebApp.

Других команд, кроме /start, нет (по ТЗ всё управление – через mini app).

История

Хранить историю диалогов отдельно для каждого пользователя + каждого персонажа.

Для LLM использовать последние 4 пары сообщений на уровне сервиса, даже если в БД храним больше.

3. Функциональные требования: админка (простая)
3.1. Авторизация админа

Вход только по Telegram ID:

бэкенд содержит список admin_telegram_ids.

Админ авторизуется через Telegram Login / WebApp или токен, который связывается с его Telegram ID.

Если telegram_user_id не в белом списке → доступ запрещён.

3.2. Управление персонажами

Экран: список персонажей

Таблица:

ID;

имя;

флаг «премиум» / «бесплатный»;

статус (активен / скрыт);

дата создания.

Действия:

создать нового персонажа;

редактировать;

деактивировать/активировать.

Экран: форма персонажа (создание/редактирование)

Поля:

Имя (строка).

Длинное описание (текст для пользователя).

Аватар:

загрузка файла → сохранение и получение URL.

Системный промпт (текст для LLM, характер и стиль персонажа).

Тип:

free / premium.

Флаг активен/неактивен (чтобы можно было скрывать персонажа из выдачи).

3.3. Пользователи и статистика

Список пользователей

Таблица:

telegram_user_id;

username;

статус подписки (none / active / expired);

дата окончания подписки;

дата регистрации / первого входа.

Без ручного продления или изменения подписки (по ТЗ это не требуется).

Простая статистика

Минимальный набор:

Кол-во зарегистрированных пользователей (всего).

Кол-во активных подписок.

Кол-во сообщений за период (день/неделя/месяц).

Топ-N персонажей:

по числу пользователей, которые с ними общались;

по числу сообщений.

4. Интеграция с LLM (OpenRouter)

Отдельный сервис/модуль LLMService:

метод generateReply(userId, characterId, messages[]).

Входные данные:

системный промпт персонажа (из БД);

контекст из 4 последних пар user ↔ bot;

текущее сообщение пользователя.

Выход:

текст ответа (строка).

Логирование запросов/ответов как отдельная фича не требуется (по ТЗ).

5. Модели данных (упрощённо)

Можно использовать как ориентир для схемы БД.

users

id

telegram_user_id (unique)

username

created_at

subscriptions

id

user_id (FK → users)

status (active / expired)

start_at

end_at

created_at

characters

id

name

description_long

avatar_url

system_prompt

access_type (free / premium)

is_active

created_at

dialogs

id

user_id

character_id

role (user / assistant)

message_text

created_at

payments

id

user_id

amount_stars

telegram_payment_id / tx_id

status

created_at

stats (опционально можно считать агрегациями, можно без отдельной таблицы).

6. Нефункциональные (минимум)

Локализация:

только русский язык для интерфейса и персонажей.

Производительность и отказоустойчивость:

жёстких требований нет (по твоему ответу), стандартный уровень.

Логирование/бэкапы:

можно ограничиться базовым логированием запросов/ошибок и периодическими бэкапами БД (без особых требований в ТЗ).